<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Visualize Variable</title>
  <link rel="stylesheet" href="switch.css">
  <link rel="stylesheet" href="spbtn.css">
  <link rel="stylesheet" href="dlbtn.css">
  <link rel="stylesheet" href="card.css">
  <style>
    /* @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap'); */

    :root {
      --bg-dark: #121214;
      --bg-panel: #1e1e24;
      --accent: #3a91ff;
      --accent-light: #679dff;
      --text-primary: #e1e1e6;
      --text-secondary: #a8a8b3;
      --border-radius: 8px;
      --transition: 0.25s ease;
      --canvas-size: 384px
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0; padding: 24px;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
        Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      user-select: none;
    }

    .container {
      flex: 1;
      display: flex;
      gap: 16px;
      align-items: center;
      flex-direction: column;
      overflow: auto;
    }

    .canvaschannel {
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }

    canvas {
      background-color: rgb(44, 44, 44);
      border-radius: var(--border-radius);
      border: 1px solid #2c2c36;
      image-rendering: pixelated;
      width: var(--canvas-size);
      height: var(--canvas-size);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
    }

    .controls {
      width: auto;
      background-color: rgb(44, 44, 44);
      border-radius: var(--border-radius);
      padding: 2px 20px;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
      position: relative;
    }

    .horizon-side {
      width:fit-content;
      background-color: var(--bg-panel);
      border-radius: var(--border-radius);
      padding: 24px 20px;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
      position: relative;
    }

    .vertical-side {
      width:fit-content;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      position: relative;
    }

    label {
      display: flex;
      flex-direction: column;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      gap: 8px;
    }

    select, input[type=range], input[type=checkbox] {
      cursor: pointer;
      border-radius: 6px;
      transition: box-shadow var(--transition), border-color var(--transition);
      outline-offset: 2px;
    }

    select {
      background-color: #2a2a34;
      border: 1px solid #44444f;
      color: var(--text-primary);
      padding: 8px 10px;
      font-weight: 500;
    }

    select:hover, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 8px var(--accent-light);
    }

    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: #2a2a34;
      border-radius: 6px;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 6px var(--accent-light);
      transition: background-color var(--transition);
    }
    input[type=range]::-webkit-slider-thumb:hover {
      background: var(--accent-light);
    }
    input[type=range]:focus {
      outline: none;
      box-shadow: 0 0 8px var(--accent-light);
    }

    input[type=checkbox] {
      width: 18px;
      height: 18px;
    }

    label.checkbox-label {
      display: flex;
      align-items: center;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      gap: 8px;
    }

  </style>
</head>
<body>
  <div class="horizon-side">
    <div class="container">
      <div class="controls">

        <button class="Btn" id="saveBtn"  title="保存">
          <svg viewBox="0 0 1024 1024" class="svgIcon">
            <path d="M870.4 614.4c-30.72 0-51.2 20.48-51.2 51.2v153.6H204.8v-153.6c0-30.72-20.48-51.2-51.2-51.2s-51.2 20.48-51.2 51.2v153.6c0 56.32 46.08 102.4 102.4 102.4h614.4c56.32 0 102.4-46.08 102.4-102.4v-153.6c0-30.72-20.48-51.2-51.2-51.2z"></path>
            <path d="M435.2 686.08c20.48 20.48 51.2 30.72 76.8 30.72s56.32-10.24 76.8-30.72L768 506.88c20.48-20.48 20.48-51.2 0-71.68s-51.2-20.48-71.68 0L563.2 563.2V153.6c0-30.72-20.48-51.2-51.2-51.2s-51.2 20.48-51.2 51.2v409.6L332.8 435.2c-20.48-20.48-51.2-20.48-71.68 0s-20.48 51.2 0 71.68l174.08 179.2z"></path>
          </svg>
        </button>

        <button class="Btn" id="copyClipBoard" title="复制">
          <svg viewBox="0 0 1025 1024" class="svgIcon">
            <path d="M688.7 1023.3H142.2c-76.2 0-138.1-62-138.1-138.1V338.7c0-76.2 62-138.1 138.1-138.1h546.5c76.2 0 138.1 62 138.1 138.1v546.5c0 76.1-62 138.1-138.1 138.1zM142.2 276.6c-34.3 0-62.1 27.9-62.1 62.1v546.5c0 34.3 27.9 62.1 62.1 62.1h546.5c34.3 0 62.1-27.9 62.1-62.1V338.7c0-34.3-27.9-62.1-62.1-62.1H142.2z"></path>
            <path d="M987.8 447.8c-21 0-38-17-38-38V141.7c0-34.3-27.9-62.1-62.1-62.1H614.1c-21 0-38-17-38-38s17-38 38-38h273.6c76.2 0 138.1 62 138.1 138.1v268.1c0 21-17 38-38 38z"></path>
          </svg>
        </button>

        <button class="Btn" id="initImg" title="复位">
          <svg class="svgIcon" viewBox="0 0 1024 1024">
            <path d="M258.275556 197.006222l50.176-50.176a9.159111 9.159111 0 0 0-5.404445-15.530666l-183.068444-21.617778a9.159111 9.159111 0 0 0-10.154667 10.183111l21.589333 183.068444a9.159111 9.159111 0 0 0 15.530667 5.404445l49.948444-49.976889 152.803556 152.689778c3.555556 3.555556 9.386667 3.555556 12.913778 0l48.469333-48.355556a9.159111 9.159111 0 0 0 0-12.885333L258.275556 197.006222z m403.057777 214.044445c3.555556 3.555556 9.386667 3.555556 12.942223 0l152.803555-152.689778 49.92 49.948444a9.159111 9.159111 0 0 0 15.559111-5.376l21.617778-182.954666a9.159111 9.159111 0 0 0-10.183111-10.183111l-183.096889 21.617777a9.159111 9.159111 0 0 0-5.376 15.530667L765.724444 197.12l-152.803555 152.576a9.159111 9.159111 0 0 0 0 12.913778l48.469333 48.440889z m231.224889 309.959111a9.159111 9.159111 0 0 0-15.559111-5.404445l-49.92 49.976889-152.803555-152.689778a9.187556 9.187556 0 0 0-12.913778 0l-48.469334 48.355556a9.159111 9.159111 0 0 0 0 12.913778l152.803556 152.775111-50.176 50.176a9.159111 9.159111 0 0 0 5.404444 15.559111l183.068445 21.589333a9.159111 9.159111 0 0 0 10.154667-10.183111l-21.589334-183.068444z m-529.92-108.117334a9.187556 9.187556 0 0 0-12.942222 0l-152.803556 152.689778-49.948444-49.948444a9.159111 9.159111 0 0 0-15.530667 5.376l-21.617777 182.954666a9.159111 9.159111 0 0 0 10.183111 10.183112l183.096889-21.617778a9.159111 9.159111 0 0 0 5.376-15.530667l-50.176-50.062222 152.803555-152.661333a9.159111 9.159111 0 0 0 0-12.913778l-48.469333-48.469334z"></path>
          </svg>
        </button>

        <div class="switch" title="维度选择">
          <input type="checkbox" id="dimFormat" class="switch-input">
          <label for="dimFormat" class="switch-label">
            <svg class="switch-icon" viewBox="0 0 1024 1024">
              <path class="switch-path" d="M895.8976 592.2816a383.1808 383.1808 0 0 0-174.4896-337.92 32 32 0 0 0-34.9184 53.5552 319.5904 319.5904 0 0 1 145.7152 267.5712 128 128 0 1 0 63.6928 16.7936z m-737.5872-16.384c1.024 0.1024 1.9456 0.1024 2.9696 0.1024 16.384 0 30.3104-12.4928 31.8464-29.0816A318.0544 318.0544 0 0 1 412.3648 271.872 128 128 0 1 0 512 63.488a128 128 0 0 0-126.1568 150.016 383.8464 383.8464 0 0 0-133.632 79.872 382.72 382.72 0 0 0-122.88 247.808 32.0512 32.0512 0 0 0 28.9792 34.7136z m538.8288 262.0416A318.1568 318.1568 0 0 1 512 896.8192a318.976 318.976 0 0 1-204.8-73.9328A128 128 0 1 0 63.488 768a128 128 0 0 0 202.752 103.936c18.432 15.36 38.4 29.0816 59.392 40.7552a385.3824 385.3824 0 0 0 186.368 48.128 381.952 381.952 0 0 0 222.1056-70.656 32 32 0 0 0-36.9664-52.224z"></path>
            </svg>
          </label>
        </div>

        <div class="switch" title="伪彩色">
          <input type="checkbox" id="colorMapToggle" class="switch-input">
          <label for="colorMapToggle" class="switch-label">
            <svg class="switch-icon" viewBox="0 0 1024 1024">
              <path class="switch-path" d="M660.879433 72.624113c43.574468 0 83.51773 3.631206 123.460993 14.524823 43.574468 10.893617 72.624113 21.787234 94.411347 43.574468 10.893617 7.262411 18.156028 14.524823 21.787234 25.41844 10.893617 10.893617 10.893617 25.41844 10.893617 32.680851 0 7.262411-7.262411 10.893617-14.524823 14.524823h-3.631205l-18.156029 7.262411c-36.312057 10.893617-68.992908 25.41844-101.673758 47.205674-87.148936 58.099291-123.460993 163.404255-98.042554 254.184397 21.787234 72.624113 68.992908 112.567376 112.567376 152.510638 14.524823 10.893617 25.41844 21.787234 39.943263 36.312057 14.524823 18.156028 25.41844 36.312057 21.787234 58.099291 0 32.680851-21.787234 68.992908-50.83688 94.411347-14.524823 14.524823-32.680851 25.41844-54.468085 36.312057-47.205674 25.41844-98.042553 43.574468-148.879433 54.468085-32.680851 7.262411-61.730496 10.893617-94.411347 10.893617-54.468085 0-105.304965-10.893617-148.879433-29.049645-50.836879-21.787234-98.042553-58.099291-137.985815-105.304965-58.099291-68.992908-94.411348-159.77305-101.673759-254.184397-3.631206-36.312057 0-76.255319 7.262411-112.567376 3.631206-10.893617 3.631206-18.156028 7.262412-29.049645 29.049645-116.198582 116.198582-217.87234 236.028368-275.971631 90.780142-47.205674 199.716312-76.255319 297.758866-76.25532m0-72.624113c-116.198582 0-232.397163 29.049645-334.070922 83.51773C199.716312 148.879433 94.411348 261.446809 58.099291 403.06383c-3.631206 10.893617-7.262411 21.787234-7.262412 32.680851-10.893617 47.205674-10.893617 90.780142-10.893617 134.35461 7.262411 105.304965 47.205674 210.609929 116.198582 294.127659 43.574468 54.468085 101.673759 98.042553 167.035461 127.092199 54.468085 21.787234 116.198582 32.680851 177.929078 32.680851 36.312057 0 72.624113-3.631206 108.93617-10.893617 58.099291-10.893617 116.198582-32.680851 170.666667-61.730496 25.41844-14.524823 47.205674-29.049645 68.992908-47.205674 72.624113-65.361702 105.304965-177.929078 29.049645-254.184397-50.836879-50.836879-112.567376-83.51773-134.35461-156.141844-21.787234-68.992908 10.893617-134.35461 68.992908-174.297873 25.41844-18.156028 54.468085-29.049645 83.51773-39.943262 7.262411-3.631206 14.524823-3.631206 21.787234-7.262411 29.049645-10.893617 54.468085-32.680851 61.730497-61.730497 7.262411-29.049645 0-65.361702-14.524823-94.411347-10.893617-18.156028-21.787234-32.680851-39.943262-43.574469-36.312057-29.049645-79.886525-43.574468-123.460993-54.468085-47.205674-10.893617-94.411348-18.156028-141.617021-18.156028z"></path>
              <path class="switch-path" d="M366.751773 639.092199c0-29.049645-25.41844-54.468085-54.468085-54.468086S257.815603 610.042553 257.815603 639.092199 283.234043 693.560284 312.283688 693.560284s54.468085-25.41844 54.468085-54.468085z m0 127.092198c-21.787234 0-36.312057 14.524823-36.312057 36.312057s14.524823 36.312057 36.312057 36.312057 36.312057-14.524823 36.312057-36.312057-14.524823-36.312057-36.312057-36.312057z m0-399.432624c-39.943262 0-72.624113 32.680851-72.624113 72.624114s32.680851 72.624113 72.624113 72.624113 72.624113-32.680851 72.624114-72.624113-32.680851-72.624113-72.624114-72.624114z m199.716312-236.028369c-61.730496 0-108.93617 47.205674-108.93617 108.93617s47.205674 108.93617 108.93617 108.936171 108.93617-47.205674 108.93617-108.936171-47.205674-108.93617-108.93617-108.93617z"></path>
            </svg>
          </label>
        </div>

        <div class="switch" title="归一化">
          <input type="checkbox" id="normalizeToggle" class="switch-input">
          <label for="normalizeToggle" class="switch-label">
            <svg class="switch-icon" viewBox="0 0 1024 1024">
              <path class="switch-path" d="M52.736 11.264c20.992 0 39.424 15.36 43.008 36.352l0.512 7.168v877.568H977.92c20.992 0 39.424 15.36 43.008 36.352l0.512 7.168c0 20.992-15.36 39.424-36.352 43.008H9.216V54.272c0-23.552 19.456-43.008 43.52-43.008z"></path>
              <path class="switch-path" d="M160.256 754.176c-5.632 0-11.776-1.536-17.408-4.608-17.408-9.728-23.552-31.232-14.336-48.64l146.944-266.24c6.144-10.752 16.896-17.92 29.696-18.432 12.288-0.512 24.064 5.12 31.232 15.36 33.28 48.128 70.144 99.328 95.232 133.632 29.184-53.76 88.576-161.792 210.944-381.44 6.144-10.752 17.408-17.92 29.696-18.432 12.288-0.512 24.064 5.12 31.232 15.36l237.056 344.576c11.264 16.384 7.168 38.4-9.216 49.664-16.384 11.264-38.4 7.168-49.664-9.216l-204.288-296.96c-86.016 155.136-195.584 352.768-205.312 373.248-4.608 11.264-14.336 19.968-26.112 22.528-24.576 5.12-35.84-10.24-58.88-40.448-11.264-14.848-26.624-35.84-45.568-61.952-10.752-14.848-20.992-29.696-30.208-42.496l-119.296 216.064c-6.656 11.776-18.944 18.432-31.744 18.432z m313.344-117.248z"></path>
            </svg>
          </label>
        </div>

        <div title="选择通道">
          <input type="checkbox" id="channelDrawerBtn">
          <label for="channelDrawerBtn" class="channelDrawerBtnToggle">
              <div class="bars" id="bar1"></div>
              <div class="bars" id="bar2"></div>
              <div class="bars" id="bar3"></div>
          </label>
        </div>


      </div>
      <div class="canvaschannel">
        <div style="overflow: auto;">
          <canvas id="imageCanvas"></canvas>
        </div>
        <div id="channelDrawerContent"></div>
      </div>
    </div>


    <div class="vertical-side">
      <div class="card">
        <div class="card__title" id="properity">properity</div>
        <div class="card__data">
          <div class="card__right">
            <div class="item">channel type</div>
            <div class="item">colors</div>
            <div class="item">normalization</div>
            <div class="item">pixel scale</div>
            <div class="item">offset height</div>
            <div class="item">offset width</div>
          </div>
          <div class="card__left">
            <div class="item" id="pro-channel">-</div>
            <div class="item" id="pro-colors">-</div>
            <div class="item" id="pro-normalization">-</div>
            <div class="item" id="pro-scale">-</div>
            <div class="item" id="pro-offset-height">-</div>
            <div class="item" id="pro-offset-width">-</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card__title" id="info-exp">expression</div>
        <div class="card__data">
          <div class="card__right">
            <div class="item">dtype</div>
            <div class="item">shape</div>
            <div class="item">channel</div>
            <div class="item">position</div>
            <div class="item">value</div>
            <div class="item">max</div>
            <div class="item">min</div>
            <div class="item">mean</div>
            <div class="item">variance</div>
          </div>
          <div class="card__left">
            <div class="item" id="info-dtype">-</div>
            <div class="item" id="info-shape">-</div>
            <div class="item" id="info-channel">-</div>
            <div class="item" id="info-position">-</div>
            <div class="item" id="info-value-contain"><span  id="info-value">-</span></div>
            <div class="item" id="info-max">-</div>
            <div class="item" id="info-min">-</div>
            <div class="item" id="info-mean">-</div>
            <div class="item" id="info-variance">-</div>
          </div>
        </div>
      </div>
    </div>


  </div>

<script>
  const vscode = acquireVsCodeApi();
  vscode.postMessage({ command: 'ready' });

  const canvas = document.getElementById('imageCanvas');
  const ctx = canvas.getContext('2d');

  let imageDataArray = null;
  let metas = null;
  let width = 0, height = 0, channels = 1;
  let currentChannel = 0;

  // 缩放和平移状态
  let pixelScale = 1;
  let offsetX = 0;
  let offsetY = 0;

  // 拖动状态
  let isDragging = false;
  let lastX = 0;
  let lastY = 0;

  const CANVAS_CSS_SIZE = 384;

  const channelDrawerBtn = document.getElementById('channelDrawerBtn');
  const channelDrawerContent = document.getElementById('channelDrawerContent');

  // 提取某通道数据
  function extractChannel(data, w, h, c, format, ch) {
    if (ch >=0)
    {
      const channelData = new Float32Array(w * h);
      if (format) { // chw
        for (let i = 0; i < w * h; i++) channelData[i] = data[ch * w * h + i];
      } else {      // hwc
        for (let i = 0; i < w * h; i++) channelData[i] = data[i * c + ch];
      }
      return channelData;
    }
    else
    {
      const pixelData = new Float32Array(w * h * c);
      if (format) { // chw
        for (let i = 0; i < w * h; i++) {
          for (let chIdx = 0; chIdx < c; chIdx++) pixelData[i * c + chIdx] = data[chIdx * w * h + i];
        }
      } else {      // hwc
        for (let i = 0; i < w * h * c; i++) pixelData[i] = data[i];
      }
      return pixelData;
    }

  }

  function normalizeData(data) {
    let min = Infinity, max = -Infinity;
    for (const v of data) {
      if (v < min) min = v;
      if (v > max) max = v;
    }
    const range = max - min || 1;
    const normData = new Uint8ClampedArray(data.length);
    for (let i = 0; i < data.length; i++) {
      normData[i] = ((data[i] - min) / range) * 255;
    }
    return normData;
  }

  function applyJetColorMap(value) {
    const fourValue = 4 * (value / 255);
    const r = Math.min(255, Math.max(0, 255 * Math.min(fourValue - 1.5, -fourValue + 4.5)));
    const g = Math.min(255, Math.max(0, 255 * Math.min(fourValue - 0.5, -fourValue + 3.5)));
    const b = Math.min(255, Math.max(0, 255 * Math.min(fourValue + 0.5, -fourValue + 2.5)));
    return [r, g, b];
  }

  function createImageData(data, w, h, useColorMap, currentChannel) {
    const imageData = new ImageData(w, h);
    for (let i = 0; i < w * h; i++) {
      if (currentChannel == -1){
        const ch = Math.floor(data.length / (w * h));
        if (ch != 3 && ch != 4){
          vscode.postMessage({ command: 'showError', text: '通道数不匹配'});
          return;
        }
        imageData.data[i * 4] = data[ch * i];
        imageData.data[i * 4 + 1] = data[ch * i + 1];
        imageData.data[i * 4 + 2] = data[ch * i + 2];
        imageData.data[i * 4 + 3] = ch === 4? data[ch * i + 3]:255;
      } else if (useColorMap) {
        const val = data[i];
        const [r, g, b] = applyJetColorMap(val);
        imageData.data[i * 4] = r;
        imageData.data[i * 4 + 1] = g;
        imageData.data[i * 4 + 2] = b;
        imageData.data[i * 4 + 3] = 255;
      } else {
        const val = data[i];
        imageData.data[i * 4] = val;
        imageData.data[i * 4 + 1] = val;
        imageData.data[i * 4 + 2] = val;
        imageData.data[i * 4 + 3] = 255;
      }
    }
    return imageData;
  }

  function drawImage() {
    if (!imageDataArray) return;

    const useColorMap = document.getElementById('colorMapToggle').checked;
    const normalize = document.getElementById('normalizeToggle').checked;
    const dimFormat = document.getElementById('dimFormat').checked;
    const channelData = extractChannel(imageDataArray, width, height, channels, dimFormat, currentChannel);
    const normData = normalize ? normalizeData(channelData) : channelData;
    const imgData = createImageData(normData, width, height, useColorMap, currentChannel);

    const offscreen = new OffscreenCanvas(width, height);
    const offCtx = offscreen.getContext('2d');
    offCtx.putImageData(imgData, 0, 0);

    canvas.width = CANVAS_CSS_SIZE;
    canvas.height = CANVAS_CSS_SIZE;

    canvas.style.width = `${CANVAS_CSS_SIZE}px`;
    canvas.style.height = `${CANVAS_CSS_SIZE}px`;

    ctx.save();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    ctx.setTransform(pixelScale, 0, 0, pixelScale, offsetX, offsetY);
    ctx.imageSmoothingEnabled = false; 
    ctx.drawImage(offscreen, 0, 0); 
    ctx.restore();
  }
  canvas.addEventListener('wheel', (e) => {
      if (e.ctrlKey) {
          e.preventDefault();

          const scaleFactor = e.deltaY < 0 ? 1.1 : 0.9;
          const rect = canvas.getBoundingClientRect();
          const mouseX = e.clientX - rect.left;
          const mouseY = e.clientY - rect.top;

          const canvasX = (mouseX - offsetX) / pixelScale;
          const canvasY = (mouseY - offsetY) / pixelScale;

          pixelScale *= scaleFactor;
          pixelScale = Math.min(Math.max(pixelScale, 0.2), 50)

          offsetX = mouseX - canvasX * pixelScale;
          offsetY = mouseY - canvasY * pixelScale;

          document.getElementById('pro-scale').textContent = pixelScale || '-';
          document.getElementById('pro-offset-height').textContent = `${offsetY}` || '-';
          document.getElementById('pro-offset-width').textContent = `${offsetX}` || '-';
          drawImage();
      }
  }, { passive: false });

  canvas.addEventListener('mousedown', (e) => {
      if (e.button === 0 && !e.ctrlKey) { 
          e.preventDefault();
          isDragging = true;
          lastX = e.clientX;
          lastY = e.clientY;
          canvas.style.cursor = 'grabbing';
      }
  });

  canvas.addEventListener('mousemove', (e) => {
      // 确保图像数据存在
      if (!imageDataArray) return;

      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      const imageX = (mouseX - offsetX) / pixelScale;
      const imageY = (mouseY - offsetY) / pixelScale;
      if (imageX >= 0 && imageX < width && imageY >= 0 && imageY < height) {
        const x = Math.floor(imageX);
        const y = Math.floor(imageY);
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = null;
        if (currentChannel == -1){
          if (document.getElementById('dimFormat').checked) {
            pos1 = 0 * height * width + y * width + x;
            pos2 = 1 * height * width + y * width + x;
            pos3 = 2 * height * width + y * width + x; 
            pos4 = channels === 4? 3 * height * width + y * width + x:null;
          } else{
            pos1 = y * width * channels + x * channels + currentChannel * 0;
            pos2 = y * width * channels + x * channels + currentChannel * 1;
            pos3 = y * width * channels + x * channels + currentChannel * 2; 
            pos4 = channels === 4? y * width * channels + x * channels + currentChannel * 3:null;
          }

          document.getElementById('info-position').textContent = `${y},${x}`;
          document.getElementById('info-value').textContent = `${imageDataArray[pos1].toFixed(2)},`
                  +`${imageDataArray[pos2].toFixed(2)},`
                  +`${imageDataArray[pos3].toFixed(2)}` 
                  + `${channels===4?','+imageDataArray[pos4].toFixed(2):''}`;

        }else{
          if (document.getElementById('dimFormat').checked) pos = currentChannel * height * width + y * width + x; 
          else pos = y * width * channels + x * channels + currentChannel;
          document.getElementById('info-position').textContent = `${y},${x}`;
          document.getElementById('info-value').textContent = `${imageDataArray[pos]}`;
        }

      } else {
        document.getElementById('info-position').textContent = '-';
        document.getElementById('info-value').textContent = '-';
      }

      if (!isDragging) e.preventDefault(); 
  });

  canvas.addEventListener('mousemove', (e) => {
      if (!isDragging) return; 
      
      e.preventDefault();
      
      const deltaX = e.clientX - lastX;
      const deltaY = e.clientY - lastY;

      offsetX += deltaX;
      offsetY += deltaY;

      lastX = e.clientX;
      lastY = e.clientY;
      
      document.getElementById('pro-offset-height').textContent = `${offsetY}` || '-';
      document.getElementById('pro-offset-width').textContent = `${offsetX}` || '-';

      drawImage();
  });

  canvas.addEventListener('mouseleave', () => {
      isDragging = false;
      canvas.style.cursor = 'default';
      document.getElementById('info-position').textContent = '-';
      document.getElementById('info-value').textContent = '-';
  });

  canvas.addEventListener('mouseup', () => {
      isDragging = false;
      canvas.style.cursor = 'default';
  });

  // 填充通道按钮，多列排列
  function populateChannelButtons(n) {
    channelDrawerContent.innerHTML = '';
    for(let i=0 - (n==3 || n==4); i<n; i++) {
      const btn = document.createElement('button');
      btn.textContent = i < 0 ? "all" : i;
      btn.dataset.channel = i;
      if(i === currentChannel) btn.classList.add('selected');
      btn.addEventListener('click', () => {
        if (currentChannel === i) return;
        currentChannel = i;
        document.getElementById('info-channel').textContent = `${i < 0 ? "all" : i}`;
        updateSelectedChannelButton();
        drawImage();
      });
      channelDrawerContent.appendChild(btn);
    }
  }

  // 更新选中样式
  function updateSelectedChannelButton() {
    const btns = channelDrawerContent.querySelectorAll('button');
    btns.forEach(b => b.classList.toggle('selected', +b.dataset.channel === currentChannel));
  }

  function initImgScalePosition(){
    if (!imageDataArray) return;
    pixelScale = Math.min(CANVAS_CSS_SIZE / width, CANVAS_CSS_SIZE / height);
    pixelScale = pixelScale = Math.min(Math.max(pixelScale, 0.2), 50);
    
    offsetX = (CANVAS_CSS_SIZE - width * pixelScale) / 2;
    offsetY = (CANVAS_CSS_SIZE - height * pixelScale) / 2;
    
    document.getElementById('pro-scale').textContent = pixelScale || '-';
    document.getElementById('pro-offset-height').textContent = `${offsetY}` || '-';
    document.getElementById('pro-offset-width').textContent = `${offsetX}` || '-';
  }

  // 按钮点击，展开/收起抽屉
  channelDrawerBtn.addEventListener('click', () => {
    channelDrawerContent.classList.toggle('open', channelDrawerBtn.checked);
  });

  // 其他控件事件
  document.getElementById('dimFormat').addEventListener('change', e => {
    const dimFormat = document.getElementById('dimFormat').checked;
    if (dimFormat) {
      [channels, height, width] = [height, width, channels];
      document.getElementById('pro-channel').textContent = 'CHW';
    }
    else {
      [height, width, channels] = [channels, height, width];
      document.getElementById('pro-channel').textContent = 'HWC' || '-';
    }
    currentChannel = 0;
    populateChannelButtons(channels);
    initImgScalePosition();
    drawImage();
  });
  document.getElementById('colorMapToggle').addEventListener('change', e => {
    const colorType = document.getElementById('colorMapToggle').checked;
    if (colorType){
      document.getElementById('pro-colors').textContent = 'JET';
    } else {
      document.getElementById('pro-colors').textContent = 'Grey';
    }
    drawImage();
  });

  document.getElementById('normalizeToggle').addEventListener('change', e => {
    const normType = document.getElementById('normalizeToggle').checked;
    if (normType){
      document.getElementById('pro-normalization').textContent = 'true';
    } else {
      document.getElementById('pro-normalization').textContent = 'false';
    }
    drawImage();
  });

  document.getElementById('saveBtn').addEventListener('click', () => {
    const dataUrl = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = `${document.getElementById('info-exp').textContent || 'image'}.png`;
    a.click();
  });

  document.getElementById('copyClipBoard').addEventListener('click', async () => {
    try {
      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
      if (!blob) throw new Error('Canvas to Blob failed');
      await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
      vscode.postMessage({ command: 'showInfo', text: '复制图片成功' });
    } catch (err) {
      vscode.postMessage({ command: 'showError', text: '复制图片失败: ' + err.message });
    }
  });

  document.getElementById('initImg').addEventListener('click', () => {
    if (!imageDataArray) return;
    initImgScalePosition();
    drawImage();
  });

  // 接收 VS Code 传输数据
  window.addEventListener('message', event => {
    const msg = event.data;
    if(msg.type === 'payload') {
      const {data, variableName, meta} = msg;
      document.getElementById('info-exp').textContent = variableName || 'expression';

      if(!data || !meta || !meta.shape || !meta.dtype) {
        vscode.postMessage({ command: 'showError', text: '缺少图像或元数据信息'});
        return;
      }
      metas = meta;
      const shape = meta.shape;
      const dtype = meta.dtype.toLowerCase();

      const raw = atob(data);
      const buffer = new ArrayBuffer(raw.length);
      const uint8View = new Uint8Array(buffer);
      for(let i=0; i<raw.length; i++) {
        uint8View[i] = raw.charCodeAt(i);
      }

      switch(dtype) {
        case 'float32': imageDataArray = new Float32Array(buffer); break;
        case 'float64': imageDataArray = new Float64Array(buffer); break;
        case 'int32': imageDataArray = new Int32Array(buffer); break;
        case 'int16': imageDataArray = new Int16Array(buffer); break;
        case 'int8': imageDataArray = new Int8Array(buffer); break;
        case 'uint16': imageDataArray = new Uint16Array(buffer); break;
        case 'uint8': imageDataArray = new Uint8Array(buffer); break;
        default:
          document.getElementById('info-dtype').textContent = `error: ${dtype}`;
          return;
      }
      
      [height, width, channels] = shape || [];
      height = height ?? 1;
      width = width ?? 1;
      channels = channels ?? 1;
      
      currentChannel = 0;
      populateChannelButtons(channels);

      document.getElementById('info-shape').textContent = `${shape}` || '-';
      document.getElementById('info-dtype').textContent = `${dtype}` || '-';
      document.getElementById('info-channel').textContent = '0';
        
      const blob = new Blob([document.querySelector('#worker-script').textContent], { type: 'application/javascript' });
      const worker = new Worker(URL.createObjectURL(blob));
      worker.postMessage({ imageDataArray });
      worker.onmessage = function (e) {
          const { max, min, mean, variance } = e.data;
          document.getElementById('info-max').textContent = `${max}` || '--';
          document.getElementById('info-min').textContent = `${min}` || '--';
          document.getElementById('info-mean').textContent = `${mean}` || '--';
          document.getElementById('info-variance').textContent = `${variance}` || '--';
        };

      initImgScalePosition();

      document.getElementById('pro-channel').textContent = 'HWC' || '-';
      document.getElementById('pro-normalization').textContent = 'false';
      document.getElementById('pro-colors').textContent = 'Grey';
      drawImage();
    }
  });
</script>
<script id="worker-script" type="application/javascript">
  self.onmessage = function (e) {
    const { imageDataArray } = e.data;
    const arr = imageDataArray;
    let max = -Infinity, min = Infinity;
    let sum = 0, sumSq = 0;
    const len = arr.length;

    for (let i = 0; i < len; i++) {
      const v = arr[i];
      if (v > max) max = v;
      if (v < min) min = v;
      sum += v;
      sumSq += v * v;
    }
    const mean = sum / len;
    const variance = sumSq / len - mean * mean;
    postMessage({ max, min, mean, variance });
  };

</script>
</body>
</html>
